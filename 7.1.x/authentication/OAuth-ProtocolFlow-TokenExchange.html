<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <!-- Required meta tags always come first -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="CAS - Enterprise Single Sign-On for the Web"/>
    <meta name="keywords" content="authentication, login, cas, central authentication service, web, java, protocol, thymeleaf,
                   open source, boot, spring, authorization, google, facebook, twitter, higher-ed, enterprise,
                   access management, single sign-on, sso, RBAC, ABAC, attributes, SAML, OpenID, openid connect,
                   JWT, ADFS"/>
    <meta name="robots" content="index,follow"/>

    
    

    







    

    <script>
        ((i, s, o, g, r, a, m) => {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-83384532-2', 'auto');
        ga('send', 'pageview');

    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.5.2/css/all.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css" />
    
    
    <link rel="stylesheet" type="text/css" media="screen" href='/cas/stylesheets/stylesheet.css'>
    <link rel="stylesheet" type="text/css" media="print" href='/cas/stylesheets/print.css'>

    <link href='https://fonts.googleapis.com/css?family=Lato:400,300,700' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic&subset=latin-ext,latin' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" rel="stylesheet">

    <title>CAS - OAuth Protocol Flow - Token Exchange</title>

</head>

<body>
    <!-- HEADER -->
    <header class="hidden-sm-down">
        <div class="container">
            <div class="row">
                <div class="col-xs-4 col-md-2">
                    <a href="../../index.html">
                        <img class="undecorated" src="/cas/images/cas_logo.png"/>
                    </a>
                </div>
                <div class="col-xs-8 col-md-6">
                    <h1>Enterprise Identity for All Earthlings and Beyond<p><sub>Identity, Single Sign-On and Access Management</sub></p></h1>
                </div>
                <div class="hidden-sm-down col-md-4">
                    <a id="forkme_banner" href="https://github.com/apereo/cas">View on GitHub</a>
                </div>

            </div>
        </div>
    </header>

    <!-- NAVBAR -->

    <nav class="navbar navbar-expand-md navbar-dark bg-primary bg-dark">
        
        <button onclick="navigateSidebar()" id="sidebarNavButton">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        
        <div class="container">
<!--            <button id="navigationNavButton" class="navbar-toggler collapsed" type="button" data-bs-toggle="collapse"-->
<!--                    data-bs-target="#navbarsExample04" aria-controls="navbarsExample04" aria-expanded="false"-->
<!--                    aria-label="Toggle navigation">-->
<!--                <span class="navbar-toggler-icon"></span>-->
<!--            </button>-->

            <div class="navbar-collapse collapse" id="navbarsExample04">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active"><a href="../../index.html" class="zoom nav-link">Home</a></li>
                    <li class="nav-item"><a href="https://github.com/apereo/cas/releases" class="zoom nav-link">Releases</a></li>
                    <li class="nav-item"><a href="../../Support.html" class="zoom nav-link">Support</a></li>
                    <li class="nav-item"><a href="../../Mailing-Lists.html" class="zoom nav-link">Mailing Lists</a></li>
                    <li class="nav-item dropdown">
                        <a class="zoom nav-link dropdown-toggle mr-md-2" href="#" id="cas-versions" data-bs-toggle="dropdown"
                           aria-haspopup="true" aria-expanded="false">Versions</a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="cas-versions">
                            
                            
                            <a class="dropdown-item" href="/cas/development/">Development</a>
                            
                            
                            
                            <a class="dropdown-item" href="/cas/7.1.x/">v7.1.x</a>
                            
                            
                            
                            <a class="dropdown-item" href="/cas/7.0.x/">v7.0.x</a>
                            
                            

                        </div>
                    </li>
                    <li class="nav-item"><a href="https://apereo.github.io" target="_blank" class="zoom nav-link">Blog</a></li>
                </ul>

            </div>

        </div>
    </nav>


    <div class="container-fluid">
        <div class="row flex-xl-nowrap">

            
                <div class="col-12 col-md-3 col-xl-2 docs-sidebar pb-5" id="sidebar"></div>

                <div class="d-none d-xl-block col-xl-2 docs-toc">
    <div id="pageContents">
        <ul class="section-nav"></ul>
    </div>
</div>

            

            <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 cas-docs-content" role="main">
                
                

                <section>
                    
                    <nav id="docsNavBar">
                        <span id="toolbarIcons"></span>
                    </nav>
                    

                    <div id="cas-docs-container">
                        
<h1 id="oauth-protocol-flow---token-exchange">OAuth Protocol Flow - Token Exchange</h1>

<p>The token exchange protocol is an extension to OAuth 2.0 that allows one OAuth 2.0 token to be
exchanged for another type of token. This exchange typically occurs between different entities in a
system, such as a client exchanging an access token for another access token with different scopes, etc.</p>

<table>
  <thead>
    <tr>
      <th>Endpoint</th>
      <th>Parameters</th>
      <th>Response</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">/oauth2.0/accessToken</code></td>
      <td><code class="language-plaintext highlighter-rouge">grant_type=...&amp;resource=https://...&amp;subject_token=...&amp;subject_token_type=...&amp;requested_token_type=...</code></td>
      <td>New exchanged token and its type.</td>
    </tr>
  </tbody>
</table>

<h2 id="application-configuration">Application Configuration</h2>

<p>The requested grant type must be <code class="language-plaintext highlighter-rouge">urn:ietf:params:oauth:grant-type:token-exchange</code>. This grant type must also be
specified for
the relevant registered service definition.</p>

<ul id="tokenexchangesvc" class="tab" data-tab="d0b1ed81-5d7e-43b9-a9c7-8bac369b39d6" data-name="tokenexchangesvc">
  
      <li class="active" id="tokenexchangesvc-impersonation">
          <a href="#">Impersonation </a>
      </li>
  
      <li id="tokenexchangesvc-delegation">
          <a href="#">Delegation </a>
      </li>
  
</ul>
<ul class="tab-content" id="d0b1ed81-5d7e-43b9-a9c7-8bac369b39d6" data-name="tokenexchangesvc">
  
      <li class="active">
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"org.apereo.cas.support.oauth.services.OAuthRegisteredService"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"clientId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"clientid"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"clientSecret"</span><span class="p">:</span><span class="w"> </span><span class="s2">"clientSecret"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"serviceId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"^(https|imaps)://&lt;redirect-uri&gt;.*"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"OAuthService"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w">
  </span><span class="nl">"supportedGrantTypes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"java.util.HashSet"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"urn:ietf:params:oauth:grant-type:token-exchange"</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">],</span><span class="w">
  </span><span class="nl">"tokenExchangePolicy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"@class"</span><span class="p">:</span><span class="w"> </span><span class="s2">"org.apereo.cas.support.oauth.services.DefaultRegisteredServiceOAuthTokenExchangePolicy"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"allowedResources"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"java.util.HashSet"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"..."</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">],</span><span class="w">
    </span><span class="nl">"allowedAudience"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"java.util.HashSet"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"..."</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">],</span><span class="w">
    </span><span class="nl">"allowedTokenTypes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"java.util.HashSet"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"urn:ietf:params:oauth:token-type:access_token"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"urn:ietf:params:oauth:token-type:jwt"</span><span class="w">
    </span><span class="p">]</span><span class="w"> </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>Furthermore, as itâ€™s shown the above example, one may define a dedicated token exchange policy that would control
the allowed resources, audience and token types for the token exchange operation. All fields defined for the
token exchange policy can accept regular expression patterns.</p>

</li>
  
      <li>
<p>The following configuration is applicable to delegation token exchange flows where the client would provide
both a <code class="language-plaintext highlighter-rouge">subject_token</code> and an <code class="language-plaintext highlighter-rouge">actor_token</code>.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"org.apereo.cas.support.oauth.services.OAuthRegisteredService"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"clientId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"clientid"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"clientSecret"</span><span class="p">:</span><span class="w"> </span><span class="s2">"clientSecret"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"serviceId"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"^(https|imaps)://&lt;redirect-uri&gt;.*"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"OAuthService"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"id"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w">
  </span><span class="nl">"supportedGrantTypes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"java.util.HashSet"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"urn:ietf:params:oauth:grant-type:token-exchange"</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">],</span><span class="w">
  </span><span class="nl">"tokenExchangePolicy"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"@class"</span><span class="p">:</span><span class="w"> </span><span class="s2">"org.apereo.cas.support.oauth.services.DefaultRegisteredServiceOAuthTokenExchangePolicy"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"allowedActorTokenTypes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"java.util.HashSet"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"urn:ietf:params:oauth:token-type:access_token"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"urn:ietf:params:oauth:token-type:jwt"</span><span class="w">
    </span><span class="p">]],</span><span class="w">
    </span><span class="nl">"requiredActorTokenAttributes"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"@class"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"java.util.HashMap"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"memberOf"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"java.util.HashSet"</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">".*can-act-as.*"</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>The subject (<code class="language-plaintext highlighter-rouge">sub</code> claim) of the subject_token is used to make the request. The actor (<code class="language-plaintext highlighter-rouge">act</code> claim) of the produced
token in the end
is the same as the subject of the <code class="language-plaintext highlighter-rouge">actor_token</code> used to make the request. This for example indicates delegation and
identifies an <code class="language-plaintext highlighter-rouge">admin</code>
as the current actor to whom authority has been delegated to act on behalf of a <code class="language-plaintext highlighter-rouge">user</code>.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"aud"</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"iss"</span><span class="p">:</span><span class="s2">"..."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"exp"</span><span class="p">:</span><span class="w"> </span><span class="mi">1234</span><span class="p">,</span><span class="w">
    </span><span class="nl">"scope"</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="p">,</span><span class="w">
    </span><span class="nl">"sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"act"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"sub"</span><span class="p">:</span><span class="s2">"admin"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>Delegation semantics are typically expressed in a token by including information about both the primary subject of 
the token as well as the actor to whom that subject has delegated some of its rights. Typically, in the request, 
the <code class="language-plaintext highlighter-rouge">subject_token</code> represents the identity of the party on behalf of whom the token is being requested while the 
<code class="language-plaintext highlighter-rouge">actor_token</code> represents the identity of the party to whom the access rights of the issued token are being delegated.</p>

</li>
  
</ul>

<h2 id="supported-exchanges">Supported Exchanges</h2>

<p>The following combinations of token types are supported for impersonation operations:</p>

<table>
  <thead>
    <tr>
      <th>Subject Token Type</th>
      <th>Issued Token Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">urn:ietf:params:oauth:token-type:access_token</code></td>
      <td><code class="language-plaintext highlighter-rouge">urn:ietf:params:oauth:token-type:access_token</code></td>
      <td>Exchange an access token for another.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">urn:ietf:params:oauth:token-type:access_token</code></td>
      <td><code class="language-plaintext highlighter-rouge">urn:ietf:params:oauth:token-type:jwt</code></td>
      <td>Exchange an access token for another as JWT.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">urn:ietf:params:oauth:token-type:access_token</code></td>
      <td><code class="language-plaintext highlighter-rouge">urn:ietf:params:oauth:token-type:id_token</code></td>
      <td>Exchange an access token for an <a href="../authentication/OIDC-Authentication.html">OpenID Connect ID token</a>.</td>
    </tr>
  </tbody>
</table>

<p>The following combinations of token types are supported for delegation operations:</p>

<table>
  <thead>
    <tr>
      <th>Subject Token Type</th>
      <th>Issued Token Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">urn:ietf:params:oauth:token-type:access_token</code></td>
      <td><code class="language-plaintext highlighter-rouge">urn:ietf:params:oauth:token-type:access_token</code></td>
      <td>Exchange an access token for another.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">urn:ietf:params:oauth:token-type:access_token</code></td>
      <td><code class="language-plaintext highlighter-rouge">urn:ietf:params:oauth:token-type:jwt</code></td>
      <td>Exchange an access token for another as JWT.</td>
    </tr>
  </tbody>
</table>

<h2 id="delegation-vs-impersonation">Delegation vs. Impersonation</h2>

<p>When principal <code class="language-plaintext highlighter-rouge">A</code> impersonates principal <code class="language-plaintext highlighter-rouge">B</code>, <code class="language-plaintext highlighter-rouge">A</code> is given all the rights that <code class="language-plaintext highlighter-rouge">B</code> has within some defined rights context and 
is indistinguishable from <code class="language-plaintext highlighter-rouge">B</code> in that context. Thus, when principal <code class="language-plaintext highlighter-rouge">A</code> impersonates principal <code class="language-plaintext highlighter-rouge">B</code>, then insofar as any 
entity receiving such a token is concerned, they are actually dealing with <code class="language-plaintext highlighter-rouge">B</code>. It is true that some members of the 
identity system might have awareness that impersonation is going on, but it is not a requirement. For all intents 
and purposes, when <code class="language-plaintext highlighter-rouge">A</code> is impersonating B, <code class="language-plaintext highlighter-rouge">A</code> is <code class="language-plaintext highlighter-rouge">B</code> within the context of the rights authorized by the token.</p>

<p>With delegation semantics, principal <code class="language-plaintext highlighter-rouge">A</code> still has its own identity separate from <code class="language-plaintext highlighter-rouge">B</code>, and it is explicitly understood that while <code class="language-plaintext highlighter-rouge">B</code> 
may have delegated some of its rights to <code class="language-plaintext highlighter-rouge">A</code>, any actions taken are being taken by <code class="language-plaintext highlighter-rouge">A</code> representing <code class="language-plaintext highlighter-rouge">B</code>. 
In a sense, <code class="language-plaintext highlighter-rouge">A</code> is an agent for <code class="language-plaintext highlighter-rouge">B</code>.</p>

                    </div>
                </section>
            </main>
        </div>
    </div>


    <footer>
        <div class="container">
            CAS is supported by the <a href="https://www.apereo.org/">Apereo Foundation</a>.
        </div>
    </footer>
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/tether@2.0.0/dist/js/tether.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>

    <script src='/cas/javascripts/URI.js'></script>
    <script src='/cas/javascripts/main.js'></script>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"></script>

    <script>
        let pageSection = 'Authentication';
        let siteUrl = '';
        let basePath = '/cas';

        
    </script>
</body>

</html>
