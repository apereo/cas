<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <!-- Required meta tags always come first -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="CAS - Enterprise Single Sign-On for the Web"/>
    <meta name="keywords" content="authentication, login, cas, central authentication service, web, java, protocol, thymeleaf,
                   open source, boot, spring, authorization, google, facebook, twitter, higher-ed, enterprise,
                   access management, single sign-on, sso, RBAC, ABAC, attributes, SAML, OpenID, openid connect,
                   JWT, ADFS"/>
    <meta name="robots" content="index,follow"/>

    
    

    







    

    <script>
        ((i, s, o, g, r, a, m) => {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-83384532-2', 'auto');
        ga('send', 'pageview');

    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css" />

    <link rel="stylesheet" type="text/css" media="screen" href="../../stylesheets/stylesheet.css">
    <link rel="stylesheet" type="text/css" media="print" href="../../stylesheets/print.css">

    <link href='https://fonts.googleapis.com/css?family=Lato:400,300,700' rel='stylesheet'>
    <link href='https://fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic&subset=latin-ext,latin' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100;200;300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" rel="stylesheet">

    <title>CAS - Graal VM Native Image Installation</title>

</head>

<body>
    <!-- HEADER -->
    <header class="hidden-sm-down">
        <div class="container">
            <div class="row">
                <div class="col-xs-4 col-md-2">
                    <a href="../../index.html">
                        <img class="undecorated" src="../../images/cas_logo.png">
                    </a>
                </div>
                <div class="col-xs-8 col-md-6">
                    <h1>Enterprise Identity for All Earthlings and Beyond</h1>
<p><sub>Identity, Single Sign-On and Access Management</sub></p>
                </div>
                <div class="hidden-sm-down col-md-4">
                    <a id="forkme_banner" href="https://github.com/apereo/cas">View on GitHub</a>
                </div>

            </div>
        </div>
    </header>

    <!-- NAVBAR -->

    <nav class="navbar navbar-expand-md navbar-dark bg-primary bg-dark">
        <button onclick="navigateSidebar()" id="sidebarNavButton">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="container">
<!--            <button id="navigationNavButton" class="navbar-toggler collapsed" type="button" data-bs-toggle="collapse"-->
<!--                    data-bs-target="#navbarsExample04" aria-controls="navbarsExample04" aria-expanded="false"-->
<!--                    aria-label="Toggle navigation">-->
<!--                <span class="navbar-toggler-icon"></span>-->
<!--            </button>-->

            <div class="navbar-collapse collapse" id="navbarsExample04">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active"><a href="../../index.html" class="zoom nav-link">Home</a></li>
                    <li class="nav-item"><a href="https://github.com/apereo/cas/releases" class="zoom nav-link">Releases</a></li>
                    <li class="nav-item"><a href="../../Support.html" class="zoom nav-link">Support</a></li>
                    <li class="nav-item"><a href="../../Mailing-Lists.html" class="zoom nav-link">Mailing Lists</a></li>
                    <li class="nav-item dropdown">
                        <a class="zoom nav-link dropdown-toggle mr-md-2" href="#" id="cas-versions" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Versions</a>
                        <div class="dropdown-menu dropdown-menu-right" aria-labelledby="cas-versions">
                            
                            
                            <a class="dropdown-item" href="/cas/7.0.x/">v7.0.x</a>
                            
                            
                            
                            <a class="dropdown-item" href="/cas/6.6.x/">v6.6.x</a>
                            
                            

                        </div>
                    </li>
                    <li class="nav-item"><a href="https://apereo.github.io" target="_blank" class="zoom nav-link">Blog</a></li>
                </ul>

            </div>

        </div>
    </nav>


    <div class="container-fluid">
        <div class="row flex-xl-nowrap">
            <div class="col-12 col-md-3 col-xl-2 docs-sidebar pb-5" id="sidebar"></div>


            <div class="d-none d-xl-block col-xl-2 docs-toc">
    <div id="pageContents">
        <ul class="section-nav"></ul>
    </div>
</div>


            <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 cas-docs-content" role="main">


                

                <section>
                    <nav id="docsNavBar">
                        <span id="toolbarIcons"></span>
                    </nav>

                    <div id="cas-docs-container">
                        
<h1 id="graal-vm-native-image-installation">Graal VM Native Image Installation</h1>

<p><a href="https://www.graalvm.org/native-image/">Graal VM Native Images</a> are standalone executables that can be generated by 
processing compiled Java applications ahead-of-time. Native Images generally have a smaller memory footprint and start faster than their JVM counterparts.</p>

<p>A CAS server installation and deployment process can be tuned to build and run as a Graal VM native image under a dedicated <code class="language-plaintext highlighter-rouge">native</code> profile. 
Compared to the Java Virtual Machine, CAS server native images can run with a smaller memory footprint and with much faster startup times. 
A CAS Graal VM Native Image is a complete, platform-specific executable. You do not need to ship a Java Virtual Machine in order to 
run a CAS native image. It requires and uses ahead-of-time (AOT) processing in order to 
create an executable. This ahead-of-time processing involves statically analyzing CAS application code from its main entry point.</p>

<div class="alert alert-warning">
<img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> <strong>Usage Warning!</strong><p>
This capability is a work in progress, requires a lot of trial and error and is highly experimental at this point. We encourage you to start 
to experiment and test your CAS deployment with this feature and contribute fixes.</p>
</div>

<p>There are some key differences between native and JVM-based CAS deployments. The main differences are:</p>

<ul>
  <li>Static analysis of the CAS server is performed at build-time from the main entry point.</li>
  <li>Code that cannot be reached when the native image is created will be removed and won’t be part of the executable.</li>
  <li>Graal VM is not directly aware of dynamic elements in CAS code and must be told about reflection, resources, serialization, and dynamic proxies.</li>
  <li>The CAS server application classpath is fixed at build time and cannot change.</li>
  <li>There is no lazy class loading and everything shipped in the final executable will be loaded in memory on startup.</li>
</ul>

<p>During the AOT processing phase, the CAS web application is started up to the point that <em>bean definitions</em> 
are available. <em>Bean instances</em> are NOT created during the AOT processing phase.</p>

<p>The AOT process, integrated directly into the CAS build, will typically generate:</p>

<ul>
  <li>Java source code under <code class="language-plaintext highlighter-rouge">build/generated/aotSources</code>
</li>
  <li>Bytecode (for dynamic proxies etc) under <code class="language-plaintext highlighter-rouge">build/generated/aotClasses</code>
</li>
  <li>Graal VM JSON hint files
    <ul>
      <li>Resource hints (<code class="language-plaintext highlighter-rouge">resource-config.json</code>)</li>
      <li>Reflection hints (<code class="language-plaintext highlighter-rouge">reflect-config.json</code>)</li>
      <li>Serialization hints (<code class="language-plaintext highlighter-rouge">serialization-config.json</code>)</li>
      <li>Java Proxy Hints (<code class="language-plaintext highlighter-rouge">proxy-config.json</code>)</li>
      <li>JNI Hints (<code class="language-plaintext highlighter-rouge">jni-config.json</code>)</li>
    </ul>
  </li>
</ul>

<p>During Spring AOT processing CAS is started up to the point that bean definitions are available. 
Bean instances are not created during the AOT processing phase.</p>

<p>Note that Hint files that are put under <code class="language-plaintext highlighter-rouge">src/main/resources/META-INF/native-image</code> are automatically picked up by Graal VM native image tool.
Generated hint files can typicallt be found in <code class="language-plaintext highlighter-rouge">build/generated/aotResources</code>.</p>

<h2 id="system-requirements">System Requirements</h2>

<p>A Graal VM distribution compatible with <a href="../planning/Installation-Requirements.html">CAS requirements</a> must be present on the build machine
and activated as the operating Java runtime. Presently and at a minimum, you will need to have Graal VM installed with 
the <a href="https://www.graalvm.org/latest/reference-manual/native-image/">native image tool</a> in place, in case your Graal VM
distribution does not offer and package this by default.</p>

<p>Needless to say, the ability to work with Graal VM native image is and will only be available in CAS deployments
that run with an <a href="../installation/Configuring-Servlet-Container-Embedded.html">embedded server container</a>.
When building a CAS Graal VM native image, an embedded server container will be automatically provided.</p>

<p>The build machine that ultimately produces the CAS Graal VM native image is preferred be running Linux 
with at least 16GB of memory and 4 CPU cores.</p>

<div class="alert alert-info">
<img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> <strong>LLVM Toolchain</strong><p>
You may run into build errors about <i>ld64 limitations</i>, particularly if you are building native images on ARM machines.
The build process may ask you to use <code>ld64.lld</code> via <code>gu install llvm-toolchain</code>.
</p>
</div>

<h2 id="installation">Installation</h2>

<p>The ability to build Graal VM native images is built directly into the CAS installation process. The installation script
can be downloaded and prepped using the <a href="../installation/WAR-Overlay-Initializr.html">CAS Initializr</a>. The produced project will
contain a <code class="language-plaintext highlighter-rouge">README</code> file with instructions on how to build and run CAS native images.</p>

<div class="alert alert-info">
<img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> <strong>Build Time</strong><p>
Building CAS Graal VM native images can be quite resource intensive and time consuming. Depending on the number of modules
included in the build, CAS configuration options and the horsepower of the build machine and available memory, the build time can vary greatly
and typically is in the neighborhood of <code>10~20</code> minutes and perhaps longer.</p>
</div>

<p>Since in AOT and native mode, configuration is being processed and the context is being optimized at build time,
any properties that would influence bean creation (such as the ones used within the bootstrap context) should be set
to the same values at build time and runtime to avoid unexpected behaviour. While building a CAS deployment that contains 
the Spring Cloud Config Client, you must make sure that the configuration data source that it connects to is available at build time. 
For example, if you retrieve configuration data from Spring Cloud Config Server, make sure you have its 
instance running and available at the port indicated in the Config Client setup.</p>

<h2 id="known-limitations">Known Limitations</h2>

<p>CAS Graal VM native images are an evolving technology. Not all libraries used by CAS and not all modules offered by CAS
provide support for native images. Additionally, the following scenarios are unsupported or do require a lot of finesse
and maneuvering to function:</p>

<ul>
  <li>Apache Log4j does not support native images; <a href="../logging/Logging-Logback.html">Logback</a> is used instead by default.</li>
  <li>All capabilities and features that load, parse and execute <a href="../integration/Apache-Groovy-Scripting.html">Groovy scripts</a>, or load dynamic code constructs.</li>
  <li>Libraries and dependencies written in Groovy or other dynamic languages will be extremely challenging to support.</li>
  <li>All capabilities and features that load CAS configuration properties from external sources that are backed by Spring Cloud.</li>
  <li>Refresh scope and dynamically refreshing the application context is not supported with CAS native images.</li>
</ul>

<p>If you find a library which does not work with Graal VM, please discuss that issue
on the <a href="https://github.com/oracle/graalvm-reachability-metadata">reachability metadata project</a>.</p>

<p>Note while the startup time is orders of magnitude faster than on the traditional JVM, 
the actual latency and throughput may be worse on the native image - there is no JIT compiler that optimizes 
code execution paths in runtime. Ideally, you should run performance tests to find out how CAS behaves 
as a native image vs a traditional JVM application.</p>

<h3 id="apache-groovy">Apache Groovy</h3>

<p>Given the dynamic nature of the Apache Groovy programming language and it meta programming model, you will find
that almost all capabilities and features in CAS that load, parse and execute Groovy scripts of any form or load dynamic code constructs
in Groovy snippets will either not work at all, or will have to be rewritten so they may be <em>statically</em> compiled by the Groovy parser.
While in native image mode, CAS will forcefully and automatically switch the Groovy compiler configuration to use Groovy’s 
static compilation feature which in some case seems to assist with native image compilation.</p>

<div class="alert alert-info">
<img class="emoji" title=":information_source:" alt=":information_source:" src="https://github.githubassets.com/images/icons/emoji/unicode/2139.png" height="20" width="20"> <strong>Remember</strong><p>Again, this only 
works in some cases and will most certainly not be a bulletproof solution. Fixes and enhancements in this area will
certainly changes to Apache Groovy and/or Graal VM's native image compiler and AOT processing itself none of which
carry any weight or scope here.</p>
</div>

<p>To learn more about Apache Groovy in CAS, please <a href="../integration/Apache-Groovy-Scripting.html">see this guide</a>.</p>

<h2 id="native-image-hints">Native Image Hints</h2>

<p>If you need to provide your own hints for reflection, resources, serialization, proxy usage etc. 
you can define your own class that implements the <code class="language-plaintext highlighter-rouge">CasRuntimeHintsRegistrar</code> API, with the following outline:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td>
<td class="rouge-code"><pre><span class="kn">package</span> <span class="nn">org.example</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyRuntimeHints</span> <span class="kd">implements</span> <span class="nc">CasRuntimeHintsRegistrar</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">registerHints</span><span class="o">(</span><span class="nc">RuntimeHints</span> <span class="n">hints</span><span class="o">,</span> 
                              <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Register your own hints...</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>You can then use <code class="language-plaintext highlighter-rouge">@ImportRuntimeHints</code> on any <code class="language-plaintext highlighter-rouge">@AutoConfiguration</code> class to activate such hints. Alternatively,
you may create the file <code class="language-plaintext highlighter-rouge">src/main/resources/META-INF/spring/aot.factories</code> with the following contents:</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
</pre></td>
<td class="rouge-code"><pre><span class="py">org.springframework.aot.hint.RuntimeHintsRegistrar</span><span class="p">=</span><span class="s">org.example.MyRuntimeHints</span>
</pre></td>
</tr></tbody></table></code></pre></div></div>

<p>CAS itself will provide a large body of native image hints for many of modules found in the codebase. This process and native image
support coverage is not exhaustive and you may be asked to register your own hints for components, APIs and processes
that are absent in CAS-provided hints. If you do run into such scenarios, consider contributing those hints
back to the CAS project directly if the hint belongs or affects a CAS-owned component, or discuss the issue with the
<a href="https://github.com/oracle/graalvm-reachability-metadata">reachability metadata project</a>.</p>

                    </div>
                </section>
            </main>
        </div>
    </div>


    <footer>
        <div class="container">
            CAS is supported by the <a href="https://www.apereo.org/">Apereo Foundation</a>.
        </div>
    </footer>

    <script>
        let pageSection = 'Installation';
    </script>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.3.2/js/tether.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js"></script>

    <script src="../../javascripts/URI.js"></script>
    <script src="../../javascripts/main.js"></script>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"></script>

</body>

</html>
