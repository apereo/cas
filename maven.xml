<project
   xmlns:j="jelly:core"
   xmlns:ant="jelly:ant"
   xmlns:util="jelly:util"
   xmlns:maven="jelly:maven">

    <j:set var="rootdir">${basedir}</j:set>
    
    <j:while test="${true}">
        <util:available file="${rootdir}/core/project.xml">
            <j:break/>
        </util:available>
        <j:set var="rootdir">${rootdir}/..</j:set>
    </j:while>

    <ant:dirname property="rootdirname" file="${rootdir}/project.xml"/>
    <j:set var="rootdir">${rootdirname}</j:set>
    <echo>Using root dir: ${rootdir}</echo>
    
    <echo>Setting rootdir to ${rootdir}</echo>

    <postGoal name="site">
        <attainGoal name="dashboard:report-single" />
    </postGoal>

    <postGoal name="multiproject">
		<j:if test="${not empty siteDir}">
		<ant:copy todir="${siteDir}">
			<ant:fileset dir="target/docs/">
				<ant:include name="**" />
			</ant:fileset>
		</ant:copy>
		</j:if>
    </postGoal>
    
    <postGoal name="jar:jar">
    
        <j:if test="${context.getVariable('signature.alias') != null}">
        	<echo>signature.alias defined; signing JAR(s)...</echo>
			<ant:signjar lazy="true" alias="${signature.alias}" storepass="${signature.storepass}" keystore="${signature.keystore}" keypass="${signature.keypass}">
				<fileset dir="${maven.build.dir}">
					<include name="*.jar"/>
				</fileset>
			</ant:signjar>
        </j:if>
   
    	<j:if test="${not empty mavenRepository}">
		    <copy todir="${mavenRepository}/cas/jars/" file="${maven.build.dir}/${pom.artifactId}-${pom.currentVersion}.jar" />
		</j:if>
		
		<j:if test="${not empty artifactsDir}">
			<copy todir="${artifactsDir}" file="${maven.build.dir}/${pom.artifactId}-${pom.currentVersion}.jar" />
		</j:if>
		
		<copy todir="${rootdir}/target" file="${maven.build.dir}/${pom.artifactId}-${pom.currentVersion}.jar" />
	</postGoal>

	<preGoal name="war:init">
		<attainGoal name="clean" />
		<attainGoal name="jar" />
		<j:set var="maven.test.skip">true</j:set>
	    <copy todir="${rootdir}/target/${pom.artifactId}/WEB-INF/lib" file="${rootdir}/target/${pom.artifactId}-${pom.currentVersion}.jar" />
	    <copy todir="${rootdir}/target/${pom.artifactId}/WEB-INF/lib" file="${rootdir}/lib/jmxremote_optional.jar" />
	    <copy todir="${rootdir}/target/${pom.artifactId}/WEB-INF/lib" file="${rootdir}/lib/jmxremote.jar" />
	</preGoal>
	
	<postGoal name="war">
		<ant:delete dir="${rootdir}/target/classes" />
		<ant:delete dir="${rootdir}/target/commons-attributes" />
		<ant:delete dir="${rootdir}/target/commons-attributes-unittest" />
		<ant:delete dir="${rootdir}/target/test-classes" />
		<ant:delete dir="${rootdir}/target/test-reports" />
	</postGoal>
	
	<goal name="cas:release">
		<j:set var="maven.javadoc.destdir">${basedir}/docs</j:set>
		<attainGoal name="javadoc" />

		<ant:mkdir dir="${rootdir}/lib/war" />
		<ant:copy todir="${rootdir}/lib/war">
			<ant:fileset dir="target/${pom.artifactId}/WEB-INF/lib/">
				<ant:include name="**" />
			</ant:fileset>
		</ant:copy>

		<ant:delete dir="${dist.dir}" />		
		<ant:mkdir dir="${dist.dir}" />
		<ant:fileset id="release" dir=".">
			<ant:include name="target/cas.war" />
			<ant:include name="target/*.jar" />
			<ant:include name="docs/**" />
			<ant:include name="core/*.xml" />
			<ant:include name="core/*.txt" />
			<ant:include name="lib/**" />
			<ant:include name="core/src/compatibility/java/**" />
			<ant:include name="core/src/main/java/**" />
			<ant:include name="core/src/test/java/**" />
			<ant:include name="core/src/test/resources/**" />
			
			<ant:include name="adaptors/cas/src/main/java/**" />
			<ant:include name="adaptors/cas/src/test/java/**" />
			<ant:include name="adaptors/cas/*.xml" />
			
			<ant:include name="adaptors/generic/src/main/java/**" />
			<ant:include name="adaptors/generic/src/test/java/**" />
			<ant:include name="adaptors/generic/*.xml" />
			
			<ant:include name="adaptors/jdbc/src/main/java/**" />
			<ant:include name="adaptors/jdbc/src/test/java/**" />
			<ant:include name="adaptors/jdbc/*.xml" />
			
			<ant:include name="adaptors/ldap/src/main/java/**" />
			<ant:include name="adaptors/ldap/src/test/java/**" />
			<ant:include name="adaptors/ldap/*.xml" />
			
			<ant:include name="adaptors/trusted/src/main/java/**" />
			<ant:include name="adaptors/trusted/src/test/java/**" />
			<ant:include name="adaptors/trusted/*.xml" />
			
			<ant:include name="adaptors/x509/src/main/java/**" />
			<ant:include name="adaptors/x509/src/test/java/**" />
			<ant:include name="adaptors/x509/*.xml" />
			
			<ant:include name="*.txt" />
			<ant:include name="project.properties" />
			<ant:include name="*.xml" />
			<ant:include name="localPlugins/**" />
			<ant:include name="webapp/**" />
		</ant:fileset>
		
		<ant:zip zipfile="${dist.dir}/${release.zip}">
			<ant:zipfileset refid="release" prefix="${release.path}" />
		</ant:zip>
		
		<ant:tar destfile="${dist.dir}/${release.tar}">
			<ant:tarfileset dir="." prefix="${release.path}">
				<ant:include name="target/cas.war" />
				<ant:include name="target/*.jar" />
				<ant:include name="docs/**" />
				<ant:include name="core/*.xml" />
				<ant:include name="core/*.txt" />
				<ant:include name="lib/**" />
				<ant:include name="core/src/compatibility/java/**" />
				<ant:include name="core/src/main/java/**" />
				<ant:include name="core/src/test/java/**" />
				<ant:include name="core/src/test/resources/**" />
				
				<ant:include name="adaptors/cas/src/main/java/**" />
				<ant:include name="adaptors/cas/src/test/java/**" />
				<ant:include name="adaptors/cas/*.xml" />
				
				<ant:include name="adaptors/generic/src/main/java/**" />
				<ant:include name="adaptors/generic/src/test/java/**" />
				<ant:include name="adaptors/generic/*.xml" />
				
				<ant:include name="adaptors/jdbc/src/main/java/**" />
				<ant:include name="adaptors/jdbc/src/test/java/**" />
				<ant:include name="adaptors/jdbc/*.xml" />
				
				<ant:include name="adaptors/ldap/src/main/java/**" />
				<ant:include name="adaptors/ldap/src/test/java/**" />
				<ant:include name="adaptors/ldap/*.xml" />
				
				<ant:include name="adaptors/trusted/src/main/java/**" />
				<ant:include name="adaptors/trusted/src/test/java/**" />
				<ant:include name="adaptors/trusted/*.xml" />
				
				<ant:include name="adaptors/x509/src/main/java/**" />
				<ant:include name="adaptors/x509/src/test/java/**" />
				<ant:include name="adaptors/x509/*.xml" />

				<ant:include name="*.txt" />
				<ant:include name="project.properties" />
				<ant:include name="*.xml" />
				<ant:include name="localPlugins/**" />
				<ant:include name="webapp/**" />
			</ant:tarfileset>
		</ant:tar>
		
		<ant:gzip src="${dist.dir}/${release.tar}" zipfile="${dist.dir}/${release.gzip}">
		</ant:gzip>
		
		<ant:checksum file="${dist.dir}/${release.gzip}" algorithm="MD5" />
		<ant:checksum file="${dist.dir}/${release.zip}" algorithm="MD5" />
		
		<ant:delete file="${dist.dir}/${release.tar}" />
		<ant:delete file="target/cas.war" />

		<ant:delete dir="${basedir}/lib/war" />

		<j:if test="${not empty artifactsDir}">
			<copy todir="${artifactsDir}" file="${dist.dir}/${release.gzip}" />
			<copy todir="${artifactsDir}" file="${dist.dir}/${release.zip}" />
			<copy todir="${artifactsDir}" file="${dist.dir}/${release.gzip}.MD5" />
			<copy todir="${artifactsDir}" file="${dist.dir}/${release.zip}.MD5" />
		</j:if>
	</goal>
</project>
